# План разработки Telegram-бота и веб‑приложения

## Цель
- Создать бота в Telegram и веб‑приложение с клубом по подписке и обучающим пространством.
- Структура уроков: темы и вкладки‑подуроки.
- Внизу веб‑приложения — панель навигации: «о клубе», «поддержка», «подписка», «домой».
- Минимальный бекэнд на SQLite, простой UI на Next.js.

## Технологии
- Бекэнд: `Node.js` + лёгкий HTTP‑фреймворк (например, `Express`) + `SQLite` (через `better-sqlite3` или `sqlite3`).
- Бот: `Node.js` + библиотека для Telegram (например, `telegraf`).
- Фронтенд: `Next.js` (App Router), CSS‑библиотека по вкусу (например, `Tailwind` или минимальные CSS‑модули).
- Аутентификация: Telegram Login Widget или OAuth‑связка учётки и Telegram‑ID.

## Структура проекта
- `backend/` — сервер, API, вебхуки оплаты и бота.
- `frontend/` — Next.js приложение.
- `database/` — файл базы `sqlite` и миграции.

## Архитектура
- Связка Telegram‑бот ↔ бекэнд:
  - Бот получает команды/кнопки, обращается к API.
  - Бекэнд хранит пользователей, подписки, уроки, прогресс.
- Веб‑приложение ↔ бекэнд:
  - UI отображает темы, уроки, статус подписки.
  - Доступ к контенту ограничен активной подпиской.

## База данных (SQLite)
- Таблицы:
  - `users` (id, telegram_id, email?, created_at)
  - `subscriptions` (id, user_id, status [active|inactive], start_at, end_at)
  - `topics` (id, title, description, order)
  - `lessons` (id, topic_id, title, content_md, order)
  - `lesson_tabs` (id, lesson_id, title, content_md, order)
  - `progress` (id, user_id, lesson_id, tab_id?, status, updated_at)
  - `payments` (id, user_id, provider, amount, currency, status, external_id, created_at)
  - `support_tickets` (id, user_id, subject, message, status, created_at)

## API (черновой список)
- Публичные:
  - `POST /api/auth/telegram` — верификация логина через Telegram.
  - `GET /api/topics` — список тем.
  - `GET /api/topics/:id/lessons` — уроки в теме.
  - `GET /api/lessons/:id` — содержимое урока и вкладок.
- Приватные (требуют авторизации):
  - `GET /api/me/subscription` — состояние подписки.
  - `POST /api/subscribe` — создание подписки/инициация оплаты.
  - `POST /api/payments/webhook` — обработка вебхуков провайдера оплаты.
  - `POST /api/support` — отправка обращения в поддержку.
  - `POST /api/progress` — отметки прохождения уроков/вкладок.

## Telegram‑бот (черновой сценарий)
- Команды: `/start`, `/subscribe`, `/lessons`, `/support`, `/about`.
- Потоки:
  - `/start` — привязка Telegram‑ID, выдача ссылки в веб‑приложение.
  - `/subscribe` — кнопка инициирует оплату, после успеха — активация подписки.
  - `/lessons` — показывает доступные темы/уроки, ссылки в веб.
  - `/support` — сбор сообщения, создание тикета.
  - `/about` — краткая информация о клубе.

## Веб‑приложение (Next.js)
- Экран «Домой» — приветствие, статус подписки, быстрые ссылки.
- «Темы» — список тем; экран «Урок» — контент и вкладки.
- «Подписка» — состояние, кнопки оплаты/продления.
- «О клубе» — описание миссии/контента.
- «Поддержка» — форма обращения.
- Нижняя панель навигации с пунктами: «домой», «о клубе», «поддержка», «подписка».

## Подписки и платежи
- Провайдер оплаты: вариант — Stripe/CloudPayments/ЮKassa (на выбор).
- Требуется вебхук для подтверждения оплаты → активация `subscriptions.status=active`.
- Альтернатива: Telegram Payments/Stars (если подходит по бизнес‑логике).

## Безопасность и доступ
- Верификация подписи Telegram Login.
- Ограничение контента по активной подписке на уровне API.
- Минимальное логирование, без хранения чувствительных данных.

## Развёртывание
- Локально: `sqlite` файл в `database/app.sqlite`.
- Прод: фронтенд на Vercel; бекэнд на Railway/Render/VM.
- Предупреждение: `SQLite` требует персистентного диска в проде. При отсутствии — рассмотреть переход на Postgres.

## Этапы (MVP → расширение)
1) Инициализация проекта и базовая структура.
2) База данных, минимальные миграции.
3) API: темы/уроки (чтение), аутентификация Telegram.
4) Бот: `/start`, ссылки, отображение тем.
5) Фронтенд: страницы, нижняя панель, рендер контента.
6) Оплата: единый провайдер, вебхук, активация подписки.
7) Ограничение доступа к урокам по подписке.
8) Поддержка: форма + тикеты.
9) Тесты и развёртывание.

## Переменные окружения
- `BOT_TOKEN` — токен Telegram‑бота.
- `WEBAPP_URL` — базовый URL фронтенда.
- `DATABASE_URL` — путь к SQLite (`file:database/app.sqlite`).
- `PAYMENT_PROVIDER_*` — ключи провайдера оплаты.

## Тестирование
- Юнит‑тесты критических модулей.
- Интеграционные тесты API.
- Ручные сценарии бота.